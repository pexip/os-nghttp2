From: Tomasz Buchert <tomasz@debian.org>
Date: Fri, 23 Aug 2019 19:03:07 +0200
Subject: Fix CVE-2019-9511 and CVE-2019-9513

Adapted cherry-pick of 83d362c6d21f76599b86e7b94cd1992288a1d43c.
---
 src/HttpServer.cc           | 2 ++
 src/shrpx_client_handler.cc | 9 +++++++--
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/HttpServer.cc b/src/HttpServer.cc
index 272a42d..eab91b9 100644
--- a/src/HttpServer.cc
+++ b/src/HttpServer.cc
@@ -650,6 +650,7 @@ int Http2Handler::read_clear() {
       }
       return -1;
     }
+    break;
   }
 
   return write_(*this);
@@ -775,6 +776,7 @@ int Http2Handler::read_tls() {
       }
       return -1;
     }
+    break;
   }
 
 fin:
diff --git a/src/shrpx_client_handler.cc b/src/shrpx_client_handler.cc
index 33b53c1..07a9b3a 100644
--- a/src/shrpx_client_handler.cc
+++ b/src/shrpx_client_handler.cc
@@ -117,6 +117,7 @@ void writecb(struct ev_loop *loop, ev_io *w, int revents) {
 int ClientHandler::noop() { return 0; }
 
 int ClientHandler::read_clear() {
+  auto should_break = false;
   for (;;) {
     if (rb_.rleft() && on_read() != 0) {
       return -1;
@@ -128,7 +129,7 @@ int ClientHandler::read_clear() {
       return 0;
     }
 
-    if (!ev_is_active(&conn_.rev)) {
+    if (!ev_is_active(&conn_.rev) || should_break) {
       return 0;
     }
 
@@ -143,6 +144,7 @@ int ClientHandler::read_clear() {
     }
 
     rb_.write(nread);
+    should_break = true;
   }
 }
 
@@ -207,6 +209,8 @@ int ClientHandler::tls_handshake() {
 }
 
 int ClientHandler::read_tls() {
+  auto should_break = false;
+
   ERR_clear_error();
 
   for (;;) {
@@ -221,7 +225,7 @@ int ClientHandler::read_tls() {
       return 0;
     }
 
-    if (!ev_is_active(&conn_.rev)) {
+    if (!ev_is_active(&conn_.rev) || should_break) {
       return 0;
     }
 
@@ -236,6 +240,7 @@ int ClientHandler::read_tls() {
     }
 
     rb_.write(nread);
+    should_break = true;
   }
 }
 
